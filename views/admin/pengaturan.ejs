<!DOCTYPE html>
<html lang="id">
<%- include('../partials/header') %>
<body>
    <div class="page">
        <%- include('../partials/sidebar') %>
        <div class="page-wrapper">
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <h2 class="page-title">
                                Pengaturan Sistem
                            </h2>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="page-body">
                <div class="container-xl">
                    <div class="row row-cards justify-content-center">
                        
                        <div class="col-md-8 col-lg-6">
                            <div class="card">
                                <div class="card-status-top bg-primary"></div>
                                <div class="card-header">
                                    <h3 class="card-title">Konfigurasi Jam Absen</h3>
                                </div>
                                <div class="card-body">
                                    <form action="/admin/pengaturan" method="POST">
                                        
                                        <div class="mb-3">
                                            <label class="form-label required">Tanggal Konfigurasi</label>
                                            <div class="input-icon">
                                                <span class="input-icon-addon">
                                                    <i class="fas fa-calendar-alt"></i>
                                                </span>
                                                <input type="date" name="tanggal_config" id="tanggalConfig" class="form-control" required>
                                            </div>
                                            <small class="form-hint text-success">
                                                <i class="fas fa-check-circle me-1"></i>
                                                Otomatis menyesuaikan tanggal hari ini (Zona Waktu Lokal).
                                            </small>
                                        </div>

                                        <div class="row mb-3">
                                            <div class="col">
                                                <label class="form-label">Jam Buka</label>
                                                <input type="time" name="jam_mulai" class="form-control" value="<%= setting.jam_mulai %>">
                                            </div>
                                            <div class="col">
                                                <label class="form-label">Jam Tutup</label>
                                                <input type="time" name="jam_selesai" class="form-control" value="<%= setting.jam_selesai %>">
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Status Sesi</label>
                                            <label class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" name="sesi_aktif" <%= setting.sesi_aktif ? 'checked' : '' %>>
                                                <span class="form-check-label">Aktifkan Absensi</span>
                                            </label>
                                            <small class="form-hint">Jika dimatikan, peserta tidak bisa melakukan scan/absen.</small>
                                        </div>
                                        
                                        <div class="mt-4">
                                            <button type="submit" class="btn btn-primary w-100">
                                                <i class="fas fa-save me-2"></i> Simpan Perubahan
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-8 col-lg-6">
                            <div class="card">
                                <div class="card-status-top bg-danger"></div>
                                <div class="card-header">
                                    <h3 class="card-title text-danger">Mulai Hari/Sesi Baru</h3>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted">
                                        Gunakan fitur ini setiap pagi atau saat ingin memulai kelas baru.
                                    </p>
                                    <ul class="list-unstyled space-y-1">
                                        <li><i class="fas fa-check text-success me-2"></i> Semua peserta bisa absen kembali.</li>
                                        <li><i class="fas fa-check text-success me-2"></i> Data statistik dashboard akan di-reset ke 0.</li>
                                        <li><i class="fas fa-info-circle text-blue me-2"></i> <strong>Data riwayat lama TIDAK akan dihapus.</strong></li>
                                    </ul>
                                    
                                    <form id="formReset" action="/admin/reset-absensi" method="POST" class="mt-4">
                                        <button type="button" class="btn btn-outline-danger w-100" onclick="confirmReset()">
                                            <i class="fas fa-sync-alt me-2"></i> Reset & Buka Sesi Baru
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            
            <footer class="footer footer-transparent d-print-none">
                <div class="container-xl">
                    <div class="text-center">
                        Copyright &copy; 2025 Sistem Absensi MRC.
                    </div>
                </div>
            </footer>
        </div>
    </div>
    
    <%- include('../partials/scripts') %>

    <script>
        // 1. LOGIKA TANGGAL OTOMATIS (Zona Waktu Lokal)
        document.addEventListener("DOMContentLoaded", function() {
            const dateInput = document.getElementById('tanggalConfig');
            
            // Cek jika input belum ada isinya (jika lupa diisi/baru buka)
            if (!dateInput.value) {
                const now = new Date();
                
                // Mendapatkan Tahun, Bulan, Tanggal Lokal
                const year = now.getFullYear();
                // getMonth() mulai dari 0, jadi tambah 1. padStart pastikan 2 digit (01, 02, dst)
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                
                // Format YYYY-MM-DD
                const localDate = `${year}-${month}-${day}`;
                
                // Set nilai input
                dateInput.value = localDate;
                console.log("Tanggal otomatis diset ke (Lokal):", localDate);
            }
        });

        // 2. SweetAlert & Reset Logic (Kode Lama)
        const urlParams = new URLSearchParams(window.location.search);
        const status = urlParams.get('status');
        const msg = urlParams.get('msg');

        if (status === 'success') {
            Swal.fire({
                icon: 'success',
                title: 'Berhasil!',
                text: msg || 'Perubahan berhasil disimpan.',
                confirmButtonColor: '#2fb344',
                timer: 3000
            }).then(() => {
                window.history.replaceState(null, null, window.location.pathname);
            });
        } else if (status === 'error') {
            Swal.fire({
                icon: 'error',
                title: 'Gagal!',
                text: msg || 'Terjadi kesalahan sistem.',
                confirmButtonColor: '#d63939'
            }).then(() => {
                window.history.replaceState(null, null, window.location.pathname);
            });
        }

        function confirmReset() {
            Swal.fire({
                title: 'Mulai Sesi Baru?',
                text: "Semua peserta akan dianggap belum hadir untuk sesi baru ini. Data lama aman.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d63939',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Reset Sekarang!',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('formReset').submit();
                }
            })
        }
    </script>
</body>
</html>